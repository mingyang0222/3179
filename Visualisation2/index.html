<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Data Visualisation 2</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    :root { box-sizing: border-box; }
    *, *::before, *::after { box-sizing: inherit; }

    body {
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 20px;
      background: linear-gradient(180deg, #eaf6ff 0%, #f7fbff 100%);
      color: #111;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 12px 60px;
    }

    .main-title {
      font-family: "Playfair Display", "Inter", serif;
      font-size: 60px;         
      font-weight: 900;
      text-align: center;
      margin: 4px 0 6px;        
      letter-spacing: 1px;
      line-height: 1.00;         
      color: #0f1724;

      white-space: pre-wrap;
      text-align: center;
    }

    .main-title::after {
      content: "";
      display: block;
      width: 1050px;                 
      height: 6px;                 
      margin: 12px auto 18px;     
      border-radius: 4px;
      background: linear-gradient(90deg, #0f1724, #8cc6d7); 
      opacity: 0.98;
    }

    .lead {
      text-align: center;
      font-size: 24px;
      color: #333;
      margin-bottom: 12px;       
      max-width: 920px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1;         
      white-space: pre-wrap;
      text-align: center;
    }

    .lead::after {
      content: "";
      display: block;
      width: 1050px;                 
      height: 6px;
      border-radius: 4px;
      background: linear-gradient(90deg, #0f1724, #8cc6d7);
      opacity: 0.98;
      position: relative;
      left: 50%;                     
      transform: translateX(-50%);   
      margin: 12px 0 18px;           
    }


    .section { margin-bottom: 10px; } 

    .section-title {
      font-size: 26px;
      margin: 2px 0 6px;         
      font-weight: 700;
      text-align: center;
      color: #111;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      line-height: 1.05;        
      white-space: pre-wrap;
    }

    .paragraph {
      font-size: 20px;
      color: #333;
      margin: 6px 0 12px;      
      line-height: 1;         
      text-align: center;
      white-space: pre-wrap;     
    }
    .paragraph strong { font-weight: 700; color: #000; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px;             
      box-shadow: 0 6px 18px rgba(20,20,20,0.04);
      overflow: visible;
      position: relative;

      min-height: 500px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 8px;                  
    }

    .card h3 {
      font-size: 18px;
      margin-bottom: 6px;        
      font-weight: 600;
      text-align: center;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #111;
      line-height: 1.02;        
      white-space: pre-wrap;
    }

    .map-container {
      width: 1040px;
      max-width: 100%;
      margin: 0 auto;
    }
    .map-embed {
      width: 100%;
      height: 500px;
    }

    .two-col-wrap {
      width: 1040px;
      max-width: 100%;
      display: flex;
      gap: 18px;                
      margin: 0 auto;
      justify-content: space-between;
      flex-wrap: nowrap;
      align-items: stretch; 
    }

    .col-half {
      width: 510px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
    }

    .stack-legend {
      height: 64px;             
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      padding-left: 6px;
      justify-content: center;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: #111;
      margin-right: 6px;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      line-height: 1.05;        
      white-space: pre-wrap;
      text-align: center;
    }
    .legend-swatch {
      width: 18px;
      height: 14px;
      border-radius: 3px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.06);
    }

    .chart-embed {
      width: 100%;
      height: 400px;   
    }

    .controls { margin-bottom: 10px; display:flex; gap:10px; align-items:center; justify-content:center; }
    label { font-size: 15px; font-family: "Inter", sans-serif; text-align: center; white-space: pre-wrap; }
    input[type="number"] { padding:6px 8px; font-size:15px; width:80px; font-family: "Inter", sans-serif; }
    button { padding:6px 10px; font-family: "Inter", sans-serif; }

    .footer-meta {
      color: #6b7280;             
      font-size: 14px;
      line-height: 1;
      text-align: center;
      max-width: 920px;
      margin: 12px auto 40px;     
      white-space: pre-wrap;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      word-break: break-word;
    }

    .footer-meta a {
      color: #6b7280;             
      text-decoration: underline;
      text-underline-offset: 3px;
      font-weight: 500;
    }

    .footer-meta ol {
      margin: 4px 0 0 0;            
      padding-left: 0;              
      list-style-position: inside;  
      text-align: center;           
      display: inline-block;         
      color: #6b7280;
    }

    .footer-meta li {
      margin: 2px 0;                
      color: #6b7280;
    }

    .card .vega-embed, .card svg, .card canvas, .card iframe {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    @media (max-width: 1040px) {
      .map-container, .two-col-wrap { width: 100%; padding: 0 12px; box-sizing: border-box; }
      .col-half { width: 100%; }
      .map-embed { height: 420px; }
      .chart-embed { height: 360px; }
      .stack-legend { height: auto; margin-bottom: 6px; }
      .main-title { font-size: 44px; line-height: 1.00; }
      .section-title { font-size: 22px; line-height: 1.05; }
      .paragraph { font-size: 16px; line-height: 1.25; }
      .card { min-height: 420px; }
    }
  </style>
</head>
<body>
  <div class="page">

    <h1 class="main-title">FROM POLLUTION TO SOLUTION</h1>

    <p class="lead"><strong>Air pollution</strong> is a global health crisis — this page walks through the problem and highlights how <strong>renewable energy</strong> is part of the solution.</p>

    <p class="paragraph">
      <strong>Background:</strong> Tiny particles in the air known as <strong>PM2.5</strong> travel deep into the lungs and bloodstream. Long-term exposure increases the risk of respiratory and cardiovascular illnesses, and contributes to premature deaths worldwide.
    </p>

    <section class="section">
      <div class="section-title">Average PM2.5 (µg/m³) — World Map</div>
      <div class="map-container">
        <div class="card">
          <div id="pm25Vis" class="map-embed"></div>
        </div>
      </div>
    </section>

    <p class="paragraph">
      <strong>Health impact:</strong> High PM2.5 concentrations are strongly associated with increased mortality — even small increases in average exposure raise the number of premature deaths.
    </p>

    <section class="section">
      <div class="two-col-wrap">
        <div class="col-half">
          <div class="card">
            <h3>Top 10 Countries — Average PM2.5</h3>
            <div id="pm25Bar" class="chart-embed"></div>
          </div>
        </div>

        <div class="col-half">
          <div class="card">
            <h3>Average Death Rate from Air Pollution</h3>

            <div class="controls" style="justify-content:center;">
              <label for="countrySelect">Compare World with:</label>
              <select id="countrySelect" style="min-width:220px; padding:6px 8px; font-size:14px;">
                <option>Loading countries…</option>
              </select>
            </div>

            <div id="vis-chart" class="chart-embed"></div>
          </div>
        </div>
      </div>
    </section>

    <p class="paragraph">
      <strong>Solution direction:</strong> Transitioning energy systems away from fossil fuels and toward <strong>renewable sources</strong> (solar, wind, hydro, biomass, geothermal) reduces emissions and improves air quality — protecting health and the environment.
    </p>

    <section class="section">
      <div class="section-title">Global Renewables (% Equivalent Primary Energy) — 2022</div>
      <div class="map-container">
        <div class="card">
          <div id="mapVis" class="map-embed"></div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="two-col-wrap">
        <div class="col-half">
          <div class="card">
            <h3>Malaysia — Renewables (% equivalent primary energy)</h3>
            <div class="controls">
              <label for="startYear">Start:</label>
              <input id="startYear" type="number" min="1965" max="2024" value="1965" />
              <label for="endYear">End:</label>
              <input id="endYear" type="number" min="1965" max="2024" value="2024" />
              <button id="resetYears">Reset</button>
            </div>
            <div id="lineVis" class="chart-embed"></div>
          </div>
        </div>

        <div class="col-half">
          <div class="card">
            <h3>Global Renewable Energy Composition by Type </h3>

            <div id="stackLegend" class="stack-legend" aria-hidden="false"></div>

            <div id="stackVis" class="chart-embed"></div>
          </div>
        </div>
      </div>
    </section>

    <p class="paragraph" style="margin-top:12px;">
      <strong>Conclusion:</strong> Reducing air pollution requires both policy action and clean energy investment. The shift to renewables is a practical and effective path from <strong>pollution</strong> to a healthier, more sustainable <strong>future</strong>.
    </p>

    <div class="footer-meta" aria-label="Document metadata">
      <div><strong>Author:</strong> CHEN MING YANG</div>
      <div><strong>Publish Date:</strong> 18 October 2025</div>
      <div><strong>Source URL:</strong></div>
      <ol>
        <li><a href="https://www.kaggle.com/datasets/anishvijay/global-renewable-energy-and-indicators-dataset" target="_blank" rel="noopener noreferrer">Kaggle — Global Renewable Energy and Indicators</a></li>
        <li><a href="https://ourworldindata.org/renewable-energy" target="_blank" rel="noopener noreferrer">Our World in Data — Renewable Energy</a></li>
        <li><a href="https://www.kaggle.com/datasets/hasibalmuzdadid/global-air-pollution-dataset" target="_blank" rel="noopener noreferrer">Kaggle — Global Air Pollution Dataset</a></li>
        <li><a href="https://www.kaggle.com/datasets/pavan9065/air-pollution?select=death-rates-from-air-pollution.csv" target="_blank" rel="noopener noreferrer">Kaggle — Air Pollution (death rates)</a></li>
      </ol>
    </div>

  </div>

  <script>
    function splitTextIntoLines(rootEl, maxWords = 12) {
      if (!rootEl) return;
      const skipTags = new Set(['SCRIPT','STYLE','INPUT','TEXTAREA','SELECT','IFRAME','CANVAS','SVG']);
      function processNode(node, counterObj) {
        if (node.nodeType === Node.TEXT_NODE) {
          const raw = node.nodeValue;
          if (!raw) return;
          const tokens = raw.match(/(\S+|\s+)/g);
          if (!tokens) return;
          const frag = document.createDocumentFragment();
          for (let i = 0; i < tokens.length; i++) {
            const tok = tokens[i];
            const isWord = /\S/.test(tok);
            frag.appendChild(document.createTextNode(tok));
            if (isWord) {
              counterObj.count++;
              if (counterObj.count >= maxWords) {
                frag.appendChild(document.createElement('br'));
                counterObj.count = 0;
              }
            }
          }
          node.parentNode.insertBefore(frag, node);
          node.parentNode.removeChild(node);
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          if (skipTags.has(node.tagName)) return;
          const display = window.getComputedStyle(node).display;
          const isBlock = display === 'block' || display === 'flex' || display === 'table' ||
                          node.tagName === 'P' || node.tagName === 'DIV' || node.tagName === 'SECTION' ||
                          node.tagName === 'H1' || node.tagName === 'H2' || node.tagName === 'H3' ||
                          node.tagName === 'LI';
          const childCounter = isBlock ? { count: 0 } : counterObj;
          const children = Array.from(node.childNodes);
          for (const cn of children) processNode(cn, childCounter);
        }
      }
      const initialCounter = { count: 0 };
      const children = Array.from(rootEl.childNodes);
      for (const c of children) processNode(c, initialCounter);
    }

    function applySplitting() {
      const safeSelectors = [
        '.main-title',
        '.lead',
        '.paragraph',
        '.section-title',
        '.card h3',
        '.legend-item',
        'label'
      ];
      safeSelectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
          splitTextIntoLines(el, 12);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      applySplitting();
      setTimeout(applySplitting, 500);
    });

  </script>

  <script>
    const stackLegendItems = [
      { key: "Biomass",    color: "#7b9acc" },
      { key: "Geothermal", color: "#f2b880" },
      { key: "Hydro",      color: "#b28fd6" },
      { key: "Solar",      color: "#ffe999" },
      { key: "Wind",       color: "#8cc6d7" }
    ];

    const legendContainer = document.getElementById('stackLegend');
    if (legendContainer) legendContainer.innerHTML = '';
    stackLegendItems.forEach(item => {
      const it = document.createElement('div');
      it.className = 'legend-item';
      const sw = document.createElement('span');
      sw.className = 'legend-swatch';
      sw.style.background = item.color;
      it.appendChild(sw);
      const lbl = document.createElement('span');
      lbl.textContent = item.key;
      it.appendChild(lbl);
      if (legendContainer) legendContainer.appendChild(it);
    });

    const mapPadding = { left: 30, right: 120, top: 20, bottom: 60 };
    const smallPadding = { left: 60, right: 20, top: 20, bottom: 40 };

    const pm25Spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "autosize": {"type":"fit","contains":"padding"},
      "padding": mapPadding,
      "width": 1040,
      "height": 500,
      "projection": {"type": "equalEarth"},
      "layer": [
        {
          "data": {"url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson",
                   "format": {"type": "topojson","feature": "oceans"}},
          "mark": {"type": "geoshape", "fill": "skyblue"}
        },
        {
          "data": {"url": "ne_110m_admin_0_countries.topojson",
                   "format": {"type": "topojson","feature": "ne_110m_admin_0_countries"}},
          "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "white"}
        },
        {
          "data": {"url": "ne_110m_admin_0_countries.topojson",
                   "format": {"type": "topojson","feature": "ne_110m_admin_0_countries"}},
          "transform": [
            {"lookup": "properties.NAME",
             "from": {
               "data": { "url": "pm25_avg_by_country.csv", "format": {"type":"csv"} },
               "key": "Country",
               "fields": ["avg_PM25"]
             }
            }
          ],
          "mark": {"type": "geoshape","stroke":"white"},
          "encoding": {
            "color": {
              "field": "avg_PM25",
              "type": "quantitative",
              "scale": {"scheme": "inferno", "reverse": true},
              "title": "Average PM2.5 (µg/m³)",
              "legend": {"orient":"right", "format": "d"}
            },
            "tooltip": [
              {"field": "properties.NAME","title":"Country"},
              {"field":"avg_PM25","title":"Average PM2.5 (µg/m³)","format":".2f"}
            ]
          }
        }
      ]
    };

    const pm25BarSpec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "autosize": {"type":"fit","contains":"padding"},
      "padding": smallPadding,
      "width": 510,
      "height": 360,
      "data": {"url":"pm25_top10.csv","format":{"type":"csv"}},
      "transform":[
        {"window":[{"op":"rank","as":"Rank"}],"sort":[{"field":"avg_PM25","order":"descending"}]},
        {"filter":"datum.Rank <= 10"}
      ],
      "mark": {
        "type": "bar",
        "cornerRadiusTopLeft": 4,
        "cornerRadiusTopRight": 4
      },
      "encoding": {
        "y": {
          "field": "Country",
          "type": "nominal",
          "sort": "-x",
          "axis": { "title": "Country", "labelFontSize": 14, "titleFontSize": 14 }
        },
        "x": {
          "field": "avg_PM25",
          "type": "quantitative",
          "axis": { "title": "Average PM2.5 (µg/m³)", "format": ".2f", "labelFontSize": 14, "titleFontSize": 14 }
        },
        "color": { "value": "#1f77b4" },
        "tooltip": [
          { "field": "Country", "type": "nominal", "title": "Country" },
          { "field": "avg_PM25", "type": "quantitative", "title": "Average (µg/m³)", "format": ".2f" }
        ]
      }
    };

    const deathsSpec = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "autosize": {"type":"fit","contains":"padding"},
      "padding": smallPadding,
      "width": 510,
      "height": 360,
      "params": [
        {"name":"selectedCountry","value":"Malaysia"} 
      ],
      "data": {"url":"deaths_airpollution_all_entities.csv","format":{"type":"csv"}},
      "transform":[
        {"calculate":"toString(datum.Year)","as":"Year_str"},
        {"filter":"datum.Entity == 'World' || datum.Entity == selectedCountry"}
      ],
      "layer":[
        {"mark":{"type":"line","interpolate":"monotone"},
         "encoding":{
           "x":{"field":"Year","type":"temporal","axis":{"title":"Year","labelFontSize":14,"titleFontSize":14}},
           "y":{"field":"DeathRate","type":"quantitative","axis":{"title":"Death rate (per 100,000)","format":".2f","labelFontSize":14,"titleFontSize":14}},
           "color":{"field":"Entity","type":"nominal","title":""},
           "tooltip": [
             {"field":"Entity","title":"Entity"},
             {"field":"Year","title":"Year","type":"temporal"},
             {"field":"DeathRate","title":"Death rate (per 100,000)","format":".2f"}
           ]
         }
        },
        {"mark":{"type":"point","filled":true,"size":30},
         "encoding":{
           "x":{"field":"Year","type":"temporal"},
           "y":{"field":"DeathRate","type":"quantitative"},
           "color":{"field":"Entity","type":"nominal"},
           "tooltip":[{"field":"Entity","title":"Entity"},{"field":"Year_str","title":"Year"},{"field":"DeathRate","title":"Death rate (per 100,000)","format":".2f"}]
         }
        }
      ],
      "config":{"legend":{"orient":"top"}}
    };

    const mapSpec = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "autosize": {"type":"fit","contains":"padding"},
      "padding": mapPadding,
      "width": 1040,
      "height": 500,
      "projection":{"type":"equalEarth"},
      "layer":[
        {"data":{"url":"https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson","format":{"type":"topojson","feature":"oceans"}},"mark":{"type":"geoshape","fill":"skyblue"}},
        {"data":{"url":"ne_110m_admin_0_countries.topojson","format":{"type":"topojson","feature":"ne_110m_admin_0_countries"}},"mark":{"type":"geoshape","fill":"lightgray","stroke":"white"}},
        {"data":{"url":"ne_110m_admin_0_countries.topojson","format":{"type":"topojson","feature":"ne_110m_admin_0_countries"}},"transform":[{"lookup":"properties.ISO_A3","from":{"data":{"url":"renewables_2022.csv","format":{"type":"csv"}},"key":"Code","fields":["Renewables (% equivalent primary energy)"]}}],"mark":{"type":"geoshape","stroke":"white"},"encoding":{"color":{"field":"Renewables (% equivalent primary energy)","type":"quantitative","scale":{"scheme":"goldgreen"},"title":"Renewables (%)","legend":{"format":"d"}},"tooltip":[{"field":"properties.NAME","title":"Country"},{"field":"Renewables (% equivalent primary energy)","title":"Renewables (%)","format":".2f"}]}},
        {"data": {
            "values": [
              {
                "country": "Iceland",
                "latitude": 64.9631,
                "longitude": -19.0208,
                "note": "Iceland leads globally due to abundant geothermal and hydropower resources."
              }
            ]
          },
          "mark": {
            "type": "text",
            "align": "left",
            "dx": -240,
            "dy": -35,
            "fontSize": 13,
            "fontWeight": "600",
            "color": "#111"
          },
          "encoding": {
            "longitude": { "field": "longitude", "type": "quantitative" },
            "latitude": { "field": "latitude", "type": "quantitative" },
            "text": { "field": "note" }
          }
        },
        {
          "data": {
            "values": [
              {
                "latitude": 64.9631,
                "longitude": -19.0208,
                "latitude_end": 90,
                "longitude_end": -70
              }
            ]
          },
          "mark": {
            "type": "rule",
            "color": "#333",
            "strokeWidth": 1.5
          },
          "encoding": {
            "longitude": { "field": "longitude", "type": "quantitative" },
            "latitude": { "field": "latitude", "type": "quantitative" },
            "longitude2": { "field": "longitude_end" },
            "latitude2": { "field": "latitude_end" }
          }
        }
      ]
    };

    const lineSpec = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "autosize": {"type":"fit","contains":"padding"},
      "padding": smallPadding,
      "width": 510,
      "height": 360,
      "params": [{"name":"startYear","value":1965},{"name":"endYear","value":2024}],
      "data":{"url":"malaysia_renewable.csv","format":{"type":"csv"}},
      "transform":[{"filter":"datum.Year >= startYear && datum.Year <= endYear"}],
      "mark":{"type":"line","point":true,"interpolate":"monotone"},
      "encoding":{
        "x":{"field":"Year","type":"quantitative","axis":{"title":"Year","labelFontSize":14,"titleFontSize":14}},
        "y":{"field":"Renewables (% equivalent primary energy)","type":"quantitative","axis":{"title":"Renewables (%)","format":".2f","labelFontSize":14,"titleFontSize":14}},
        "tooltip":[{"field":"Year","title":"Year"},{"field":"Renewables (% equivalent primary energy)","title":"Renewables (%)","format":".2f"}]
      }
    };

    const stackSpec = {
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "autosize": {"type":"fit","contains":"padding"},
      "padding": smallPadding,
      "width": 510,
      "height": 360,
      "data":{"url":"global_energy_type_composition.csv","format":{"type":"csv"}},
      "mark":"bar",
      "encoding":{
        "x":{"field":"Year","type":"ordinal","axis":{"title":"Year","labelAngle":-45,"labelFontSize":12,"titleFontSize":13}},
        "y":{"field":"Production (GWh)","type":"quantitative","stack":"normalize","axis":{"title":"Share of Total Renewable Energy (%)","format":"%","labelFontSize":12,"titleFontSize":13}},
        "color":{
          "field":"Energy Type",
          "type":"nominal",
          "title":"Energy Source",
          "scale": {
            "domain": ["Biomass","Geothermal","Hydro","Solar","Wind"],
            "range": ["#7b9acc", "#f2b880", "#b28fd6", "#ffe999", "#8cc6d7"]
          },
          "legend": null  
        }
      },
      "config": {
        "axis": {"labelFontSize": 12, "titleFontSize": 13}
      }
    };

    vegaEmbed("#pm25Vis", pm25Spec, {mode:"vega-lite", actions:false}).catch(console.warn);
    vegaEmbed("#pm25Bar", pm25BarSpec, {mode:"vega-lite", actions:false}).catch(console.warn);
    vegaEmbed("#mapVis", mapSpec, {mode:"vega-lite", actions:false}).catch(console.warn);
    vegaEmbed("#lineVis", lineSpec, {mode:"vega-lite", actions:false}).then(result=>{
      const view = result.view;
      const s = document.getElementById("startYear");
      const e = document.getElementById("endYear");
      const reset = document.getElementById("resetYears");
      if (s && e && reset) {
        function updateYears(){
          let sVal = parseInt(s.value,10);
          let eVal = parseInt(e.value,10);
          if (Number.isNaN(sVal)) sVal = 1965;
          if (Number.isNaN(eVal)) eVal = 2024;
          if (sVal > eVal) [sVal,eVal] = [eVal,sVal];
          view.signal("startYear", sVal).signal("endYear", eVal).run();
        }
        s.addEventListener("change", updateYears);
        e.addEventListener("change", updateYears);
        reset.addEventListener("click", ()=>{ s.value=1965; e.value=2024; updateYears(); });
        view.signal("startYear", parseInt(s.value,10)).signal("endYear", parseInt(e.value,10)).run();
      }
    }).catch(console.warn);

    (async function(){
      const select = document.getElementById("countrySelect");
      const csvUrl = "deaths_airpollution_all_entities.csv";

      try {
        const resp = await fetch(csvUrl);
        if (!resp.ok) throw new Error("Failed to fetch CSV: " + resp.status);
        const text = await resp.text();

        const lines = text.split(/\r?\n/).filter(Boolean);
        if (lines.length < 2) throw new Error("CSV seems empty or only header");

        const header = lines[0].split(',');
        const entityIdx = header.findIndex(h => h.trim().toLowerCase() === 'entity');
        if (entityIdx === -1) throw new Error("No 'Entity' column found in CSV header");

        const entitiesSet = new Set();
        for (let i = 1; i < lines.length; i++) {
          const row = lines[i].split(',');
          const ent = row[entityIdx] ? row[entityIdx].trim() : "";
          if (ent) entitiesSet.add(ent);
        }

        const entities = Array.from(entitiesSet).sort((a,b)=> a.localeCompare(b));

        select.innerHTML = "";
        entities.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

        let defaultCountry = "Malaysia";
        if (!entities.includes(defaultCountry)) defaultCountry = entities[0] || "";

        const embedRes = await vegaEmbed("#vis-chart", deathsSpec, {mode:"vega-lite", actions:false});
        const view = embedRes.view;

        if (defaultCountry) {
          select.value = defaultCountry;
          try { view.signal("selectedCountry", defaultCountry).run(); } catch(e){ console.warn(e); }
        }

        select.addEventListener("change", (ev)=>{
          const val = ev.target.value;
          try {
            view.signal("selectedCountry", val).run();
          } catch(err){
            console.warn("Failed to update selectedCountry signal:", err);
          }
        });

        setTimeout(()=> {
          try { view.run(); } catch(e){/* ignore */ }
        }, 200);

      } catch (err) {
        console.error("Could not populate country selector or embed deaths chart:", err);
        select.innerHTML = "<option>Error loading countries</option>";
        vegaEmbed("#vis-chart", deathsSpec, {mode:"vega-lite", actions:false}).catch(console.warn);
      }
    })();

    vegaEmbed("#stackVis", stackSpec, {mode:"vega-lite", actions:false}).catch(console.warn);
  </script>
</body>
</html>
